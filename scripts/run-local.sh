#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ ChildDev –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏"
echo "====================================="

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –º—ã –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
if [ ! -f "README.md" ]; then
    echo "‚ùå –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ .env —Ñ–∞–π–ª–æ–≤
if [ ! -f ".env.local" ]; then
    echo "‚ùå –§–∞–π–ª .env.local –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ ./scripts/dev-setup.sh"
    exit 1
fi

echo "üìÑ –ó–∞–ø—É—Å–∫ PDF —Å–µ—Ä–≤–∏—Å–∞..."
cd services/pdf

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π PDF —Å–µ—Ä–≤–∏—Å–∞
if [ ! -d "node_modules" ]; then
    echo "‚ùå –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ PDF —Å–µ—Ä–≤–∏—Å–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã. –ó–∞–ø—É—Å—Ç–∏—Ç–µ ./scripts/dev-setup.sh"
    exit 1
fi

# –ó–∞–ø—É—Å–∫ PDF —Å–µ—Ä–≤–∏—Å–∞ –≤ —Ñ–æ–Ω–µ
npm run dev > ../../logs/pdf-service.log 2>&1 &
PDF_PID=$!
echo "‚úÖ PDF —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω (PID: $PDF_PID) –Ω–∞ –ø–æ—Ä—Ç—É 3001"

# –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ PDF —Å–µ—Ä–≤–∏—Å–∞
sleep 3

echo "üåê –ó–∞–ø—É—Å–∫ Web —Å–µ—Ä–≤–∏—Å–∞..."
cd ../web

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Web —Å–µ—Ä–≤–∏—Å–∞
if [ ! -d "node_modules" ]; then
    echo "‚ùå –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Web —Å–µ—Ä–≤–∏—Å–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã. –ó–∞–ø—É—Å—Ç–∏—Ç–µ ./scripts/dev-setup.sh"
    exit 1
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –ª–æ–≥–æ–≤
mkdir -p ../../logs

# –ó–∞–ø—É—Å–∫ Web —Å–µ—Ä–≤–∏—Å–∞ –≤ —Ñ–æ–Ω–µ
npm run dev > ../../logs/web-service.log 2>&1 &
WEB_PID=$!
echo "‚úÖ Web —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω (PID: $WEB_PID) –Ω–∞ –ø–æ—Ä—Ç—É 3002"

cd ../..

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ PID –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
echo $PDF_PID > .pdf.pid
echo $WEB_PID > .web.pid

echo ""
echo "üéâ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã!"
echo ""
echo "üì± –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: http://localhost:3002"
echo "üìÑ –§–∏–ª–≤–æ—Ä–¥: http://localhost:3002/filword"
echo "üîß PDF API: http://localhost:3001/health"
echo ""
echo "üìã –õ–æ–≥–∏:"
echo "   Web: tail -f logs/web-service.log"
echo "   PDF: tail -f logs/pdf-service.log"
echo ""
echo "‚èπÔ∏è  –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: ./scripts/stop-local.sh"
echo ""

# –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–∫–∞ —Å–µ—Ä–≤–∏—Å—ã —Å—Ç–∞—Ä—Ç—É—é—Ç
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞—Ä—Ç–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sleep 5

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç
./scripts/check-health.sh